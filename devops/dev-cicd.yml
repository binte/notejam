trigger:
  batch: true
  branches:
      include:
      - develop
      - devops/*

variables:
  vmImage: 'ubuntu-20.04'

stages:
- stage: 'Build'
  displayName: 'Build the web application'
  jobs: 
  - job: 'Build'
    displayName: 'Build job'
    pool:
      vmImage: $(vmImage)
    steps:
      - task: NodeTool@0
        displayName: 'Use Node 14'
        inputs:
          versionSpec: 14.x
          checkLatest: true
      - task: Npm@1
        displayName: 'Installing NPM packages'
        inputs: 
          command: custom
          workingDir: expressApp
          verbose: false
          customCommand: 'ci'
      - task: Npm@1
        displayName: 'Creating DB schema'
        inputs: 
          command: custom
          workingDir: expressApp
          verbose: false
          customCommand: 'run db'
      - task: ArchiveFiles@2
        displayName: 'Archiving express app files'
        inputs:
          rootFolderOrFile: expressApp
          archiveFile: expressApp/artifact/expressApp.zip
      - task: PublishBuildArtifacts@1
        displayName: 'Publishing expressApp files'
        inputs:
          pathToPublish: expressApp/artifact
          artifactName: expressApp
      - task: ArchiveFiles@2
        displayName: 'Archiving terraform files'
        inputs:
          rootFolderOrFile: devops/terraform
          archiveFile: devops/terraform/artifact/tf.zip
      - task: PublishBuildArtifacts@1
        displayName: 'Publishing terraform files'
        inputs:
          pathToPublish: devops/terraform/artifact
          artifactName: terraform
