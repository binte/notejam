trigger:
  batch: true
  branches:
      include:
      - develop
      - devops/*

variables:
  vmImage: 'ubuntu-20.04'

stages:
- stage: 'Build'
  displayName: 'Build the web application'
  jobs: 
  - job: 'Build'
    displayName: 'Build job'
    pool:
      vmImage: $(vmImage)
    steps:
      - task: NodeTool@0
        displayName: 'Use Node 14'
        inputs:
          versionSpec: 14.x
          checkLatest: true
      - task: Npm@1
        displayName: 'Installing NPM packages'
        inputs: 
          command: custom
          workingDir: expressApp
          verbose: false
          customCommand: 'ci'
      - task: Npm@1
        displayName: 'Creating DB schema'
        inputs: 
          command: custom
          workingDir: expressApp
          verbose: false
          customCommand: 'run db'
      - task: ArchiveFiles@2
        displayName: 'Archiving express app files'
        inputs:
          rootFolderOrFile: expressApp
          archiveFile: appArtifact/expressApp.zip
      - task: PublishBuildArtifacts@1
        displayName: 'Publishing expressApp files'
        inputs:
          pathToPublish: appArtifact
          artifactName: expressApp
      - task: ArchiveFiles@2
        displayName: 'Archiving terraform files'
        inputs:
          rootFolderOrFile: devops/terraform
          archiveFile: tfArtifact/tf.zip
      - task: PublishBuildArtifacts@1
        displayName: 'Publishing terraform files'
        inputs:
          pathToPublish: tfArtifact
          artifactName: terraform

- stage: 'DEV'
  displayName: 'Deploy to the DEV environment'
  dependsOn: Build
  jobs:
  - job: Provision
    displayName: 'Provision infrastructure'
    pool:
      vmImage: $(vmImage)
    steps:
#    - task: DownloadPipelineArtifact@2
#      inputs:
#        artifact: tfArtifact
    - script: |
        # Exit when any command returns a failure status.
        set -e

        # Initialize Terraform.
        terraform init -input=false -backend-config="devops/terraform/backend.tfvars"
        # Apply the Terraform plan.
        terraform apply -input=false -auto-approve

        # Get the App Service name for the dev environment.
        WebAppNameDev=$(terraform output appservice_name_dev)

        # Write the WebAppNameDev variable to the pipeline.
        echo "##vso[task.setvariable variable=WebAppNameDev;isOutput=true]$WebAppNameDev"
      name: 'RunTerraform'
      displayName: 'Run Terraform'
      env:
        ARM_CLIENT_ID: $(ARM_CLIENT_ID)
        ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
        ARM_TENANT_ID: $(ARM_TENANT_ID)
        ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
